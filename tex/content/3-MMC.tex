% !TEX root = ../thesis-example.tex
%todo: to describe the basic magic mirror idea, hardware and framework
%Magic Mirror framework: conception, software and hardware
\section{Magic Mirror Framework} \label{sec:3-PPMM:MMC}
%the reason to choose anatomy learning for magic mirror conception
Knowledge about human anatomy is an important issue for everyone working in the field of medicine. But it is also an important part of the general education and relevant for many other professions related e.g. to health-care or sports. The human anatomy is very complex and it does not only involve knowledge about the single organ, but also about issues such as chemical processes, human motion and spatial relations inside the body. Therefore, teaching human anatomy is very difficult and often big effort is spent on teaching it e.g. by letting students perform dissection courses, creating illustrations and plastic models of anatomy or by utilizing 3D computer graphics. 

The magic mirror\cite{Grosjean1999} is a user interface technique that mimics a normal mirror and presents non-physical visual feedback in addition to the normally optical effect. Here the user stands in front of a screen and via a camera, the image of the user is shown on the screen such that it acts like a mirror. 
While previous systems have augmented objects onto the user, this system extends the magic mirror concept for medical education and rehabilitation. It creates the illusion that the user can look inside his/her own body. An image of this can be seen in \figurename{\ref{fig:3-MMC:Prototype}}. To achieve this visualization, the magic mirror augments the volume visualization of a CT dataset onto the user. To allow a correct augmentation of the medical data, the pose of the user is tracked. Hence, an MR magic mirror conception came out as a framework and it generates a personalized perception of the medical information for every user. This conception can also display anatomical structures overlaid onto the body of the user to intuitively teach human anatomy. In addition, the framework takes the user's natural gesture as input to create an interactive MR environment. 

\subsection{Magic Mirror Prototype}
The augmented reality magic mirror prototype in this section is firstly presented as an interactive anatomy learning system and has primarily been developed for medical anatomy education, museum, and exhibition. It focuses on a few important organs of the abdomen, such as liver, lungs, pancreas, stomach, and bones.  
The system prototype has a mirror-like effect to the user by projecting a `looking glass' on the body (see \figurename{\ref{fig:3-MMC:Prototype}}). The prototype of the magic mirror is largely based on a software framework that has been developed for HMD-based AR. The system can currently display the skeleton of the user, rendered from pre-operative CT data. The magic mirror tracks users' movements using a depth camera and an algorithm to detect the pose of the user from the depth image. This is realized using the Microsoft Kinect which was originally developed to allow controlling computer games by motion. By using the magic mirror metaphor, the user is led to believe that he or she is able to look inside their own body. At the same time, radiological information (CT, MRI data and a fully segmented dataset of cross-sectional photographs of the human body) are displayed in real-time. The current system allows visualization of static anatomy on the user and offers a simple user interface to select CT, MR or photographic slices \cite{Blum2012,Navab2012a}.
\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{figures/3-MMC/Figure1}
	\caption[The Magic Mirror]{The system prototype has a mirror-like effect to the user by projecting a `looking glass' on the body. By using the magic mirror metaphor, the user is led to believe that he or she is able to look inside their own body.}
	\label{fig:3-MMC:Prototype}
\end{figure}

\subsubsection{Hardware setup}
An illustration of the hardware setup can be seen in \figurename{ \ref{fig:3-MMC:hardware:a}}. The first component of the system is a display device. In different setups of the system large TV screens or video projection onto a planar surface has been used. The second component is a color camera, which is mounted next to the display surface and which is looking at the user and perceive the visual information. The third component is a depth sensor which is placed next to the color camera and which has a similar field of view and viewing direction as the color camera to collect the user's skeleton information. 
The current system uses the Microsoft Kinect (Microsoft Corporation, Redmond, United States), which is sold as an add-on for the Xbox 360 video game console (see \figurename{ \ref{fig:3-MMC:hardware:b}}).
It consists of a color and a depth camera that are assembled into one housing. The depth sensor is an infrared camera that uses structured light, which is emitted by an additional infrared projector to estimate depth values for each pixel. The user's skeleton and personal information can be generated from the Kinect sensor based on the machine learning.
Our system prototype employs the color camera to create a mirror-like effect to the user, and all the non-physical visual feedback is generated based on the user's skeleton and personal information via rendering the corresponding medical information onto the human body.

%two picture: left generate design, right the current hard ware
\begin{figure}
	\centering
	\caption[Magic Mirror Hardware setup]{Magic Mirror Hardware setup. (a) The system consists of a display, a color camera and a depth sensor. The color camera perceives the visual image, which is shown in the display to generate a mirror effect. The depth sensor observes the user and collects natural input for interaction with the system. (b) The Microsoft Kinect consists of a color and a depth camera that are assembled into one housing.}
	\label{fig:3-MMC:hardware}
	\subfloat[General Design]{\label{fig:3-MMC:hardware:a}
		\includegraphics[width = 0.5\linewidth]{figures/3-MMC/GeneralSetup.png}
	}
	\subfloat[Current Implemetation using Kinect]{ \label{fig:3-MMC:hardware:b}
		\includegraphics[width = 0.5\linewidth]{figures/3-MMC/mirracleIllustration.png}
	}
\end{figure}

\subsubsection{Software framework}
The system framework of the prototype is illustrated in \figurename{ \ref{fig:3-MMC:systemFramework}}.
To access the Kinect the system uses OpenNI\footnotemark, which is an open source software framework that allows retrieving color and depth images from the Kinect. The depth sensor is used for two purposes. First, the depth values are projected to the color image providing depth information for each pixel in the color image. This functionality is implemented in OpenNI. Second, a skeleton tracking algorithm uses the depth image to track the pose of multiple joints of a user who is standing in front of the camera. For skeleton tracking the magic mirror uses NITE\footnotemark[\value{footnote}] a software by PrimeSense that performs gesture recognition and skeleton tracking based on depth images. NITE can be used with the Kinect through the OpenNI framework. \footnotetext{\url{https://en.wikipedia.org/wiki/OpenNI}}

The magic mirror AR view is based on the information perceived via OpenNI and corresponding medical information. There are four modules \textit{Skeleton \& Personal Information Processing}, \textit{Color \& Depth Image Processing}, \textit{3D Medical Information Rendering}, and \textit{2D Information} to generate the mirror-like effect and non-physical visual feedback. \textit{Skeleton \& Personal Information Processing} is very important to achieve personal perception and the details is discussed in the following sections. \textit{Color \& Depth Image Processing} is the basic module to generate the mirror-like effect and merge the non-physical visual outcome. \textit{3D Medical Information Rendering} renders the corresponding 3D medical images or models to virtual elements for the magic mirror AR view and it could employ OpenGL and OpenGl Shading Language, and any other 3D rendering libraries, e.g. Coin3D. \textit{2D Information} includes window management and basic user interface elements, such as 2D text and image information, and it can be implemented using Qt.

The applications based on the \textit{Matic Mirror AR View} has two important features, \textbf{AR \textit{in-situ view}} and \textbf{Interactive Mixed Reality}. The top rectangles represent the basic visualization functions of the system, which would be discussed in more detail later. The prototype system which is presented in this section is a personalized magic mirror system for anatomy learning (see \figurename{\ref{fig:3-MMC:Prototype}). It focuses on bones and important organs of the thorax and abdomen. The system can currently provide AR in-situ visualization, render skeleton from an original CT-volume, and showcase 3D models of organs. A sensor tracks the user positions in real-time, and contextual in-situ visualization algorithms enable the augmentation of organs and bones directly onto the user body.
%Raw color => display as background. Depth image=> skeleton => transformation of the CT volume, 3D rendering, interaction API to \\
%Function widget => real function to improve the perception. 
\begin{figure}
	\centering
	\caption[Magic Mirror system framework]{Magic Mirror system framework. The lowest two layers represent the open soure library to access the kinect raw image data and skeleton information. The middle layer is the modules used to create magic mirror AR view of the user. The top level is the application with basic functions.}
	\label{fig:3-MMC:systemFramework}
	\includegraphics[width = 0.7\linewidth]{figures/3-MMC/SystemFramework}
\end{figure}

\subsubsection{Medical Information}
To create a magic mirror AR view for anatomy leaning, special medical data should be selected from the database and transformed based on current user's personal and skeleton information (see \figurename{\ref{fig:3-MMC:MedicalInfoFlow}}). Then the data is rendered to generate the non-physical visual effect, merging with the mirror-like image. The user learns anatomy knowledge via perception of the AR view of his/her own body. Interaction can also be performed by the user intentionally or unintentionally to control the  selection and transformation of the medical information, enabling an interactive AR view.
\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{figures/3-MMC/MedicalInfoFlow}
	\caption[Medical Information Flow]{For each non-physical visual effect, corresponding medical information is selected from the medical information database, transformed, and rendered according to the function setting and the user interaction. Finally, the magic mirror AR view is generated.}
	\label{fig:3-MMC:MedicalInfoFlow}
\end{figure}

Except text and 2D atlas, 3D image is an important methodology to represent medical information. There are two general ways to represent 3D data. The common way in medicine is to use volumes, where we have one pixel or voxel for every point in 3D. This is the kind of data we get from CT or MR. The other one are polygonal or surface models, where only the surface (e.g. skin or the surface of the liver) is stored. For models that have been created for education often surface models are used because they look better.
Visualizing structures other than bones from the CT is more challenging. In a first attempt the segmentation that is available for the CT volume was used to visualize different organs in the abdominal area. The quality of the visualization was low, as the segmentation does not have sub-pixel accuracy and transfer-functions on CT intensities cannot provide a visualization with realistic colors and textures of organs. Therefore instead of using the volumetric data, additional polygonal models were integrated. The Anatomium dataset\footnote{\url{www.anatomium.com}} provides polygonal models of many organs of the human body. A scene graph including multiple organs was extracted from the dataset. Using Coin3D this scene graph is augmented onto the user. The simultaneous visualization of bones from CT and a polygonal model of the small intestine is shown in \figurename{\ref{fig:3-MMC:Prototype}.

One drawback of the current system is that the 3D dataset is not deformed. So if the user bends, this is not reflected in the visualization of the medical data and also movements of the limbs are not visualized correctly. While later, possible solutions to address this issue are discussed, for the current system, which focuses on the abdominal area, this is a minor problem.	
While the system could use a CT scan of the user, for medical education it is not possible to acquire a CT scan of the user if it is not required for medical reasons. Therefore, we augment the CT of another person onto the user. Therefore we use the Visible Korean Human dataset (VKH) \cite{Park2006}. This dataset consists of a CT scan, a MR volume and a photographic volume which has been acquired by stacking up cryosections. 
Most CT and MRI medical images are saved in the DICOM standard, which is the format that is used in all hospitals. Unfortunately, most software for research does not support DICOM. The magic mirror system takes a the `\textit{\*.MHD}' file as the medical data.

\subsection{Personal perception and interaction}
\subsubsection{Calibration of the user}
The skeleton tracking algorithm has to calibrate the user. For this, the user has to take a certain pose and hold it for several seconds. This calibration estimates the individual distances between joints for each user. This allows estimating the size of the user. The 3D volume and models are scaled to the size of the user and augmented onto the user.  
The NITE skeleton tracking algorithm, which is used in the magic mirror system, also requires the user to calibrate before the tracking works. In order to build a system that people can use without further instruction, we need to attract their attention and develop a self-explaining system. The NITE skeleton tracking can detect a user before the user is calibrated. It cannot estimate the poses of the skeleton joints, but provides a pixel map, where all pixels that belong to a person are labeled. We use this to attract the attention of people passing by. As soon as someone walks into the field of view of the camera, that person is augmented with green color. Now the user has to take a calibration pose where both arms have to be put into the air. The system augments a silhouette of a person taking this pose onto the display and asks the user to take the same position. During the calibration procedure, which last a couple of seconds, a red laser scanning the user from top to bottom is augmented onto the mirror. After calibration finished the systems prints a message telling that the life form has been recognized as human and the AR view will be turned on.

\subsubsection{AR in-situ visualization of human anatomy}
For a personalized visualization of organs we employ the concept of a magic mirror. The camera image is flipped horizontally and shown on the screen such that the user has the impression of standing in front of a mirror. The system tracks all user movements using a depth camera and an algorithm to detect the pose of the user from the depth image. Then, virtual objects can be added to the image of the real scene. By using the magic mirror metaphor, the user is led to believe that he or she is able to look inside their own body. At the same time, radiological information (CT data and a fully segmented dataset of cross-sectional photographs of the human body) are displayed in real-time \cite{Blum2012}.
\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{figures/3-MMC/Mirracle}
	\caption[Magic Mirror Demo]{The AR \textit{in-situ} visualization of human anatomy in the prototype magic mirror demo.}
	\label{fig:3-MMC:Mirracle}
\end{figure}
For the augmentation the same focus and context visualization \cite{Bichlmeier2007} is used, such that the virtual objects are only shown through a circular focus window (see \figurename{\ref{fig:3-MMC:Mirracle}). This leads to a better perception of depth, compared to a simple augmentation of the whole CT. 
For visualization of the bones a transfer function is used as bone can be distinguished easily in the CT volume based on the voxel intensities. A visualization of the bones from the CT using direct volume rendering (DVR) is shown in \figurename{\ref{fig:3-MMC:Mirracle}. For other applications, such as patient-doctor communication it would also be possible to augment a CT dataset of the user's own body.

\paragraph{Presentation of additional medical information}
While the AR visualization is suited well for showing the position of different organs and 2D slices from the CT or photographic volume, it is not suited well to display more detailed information. In addition to the AR in-situ visualization of anatomy we want to display text, images and 3D models to provide more information about anatomical structures. To do this, our system switches to a mode, where no magic mirror visualization is used, but the whole screen is used to display additional information. Therefore, the user can switch to the 2D info or the 3D models mode. In this mode either a 3D view of organs or 2D information about the organs can be displayed.

\subsubsection{Natural User interaction}
The color image of the user is used to create the mirror-like effect, and the non-physical visual image is directly augmented onto the user's body based on the skeleton information. Hence, all the body movements are directly employed for the interaction. Arm and hand gestures can also be used to perform interaction with the magic mirror AR view.

\paragraph{Gesture-based interaction for slices}: Medical volumes are usually visualized by showing slices that are aligned with the axes of the volume. A volume can be seen as a stack of transverse slices starting from the top and going to the bottom. When the system is in the transverse slice mode, the user could move their hand up or down to choose the interesting slice image (see \figurename{\ref{fig:3-MMC:Mirracle} and \figurename{fig:3-MMC:NUI:a}), respectively left or right for the sagittal slice mode. The current slice is depicted on the right part of the monitor while a yellow circle is augmented onto the user depicting the slice plane. The system can easily switch slices between the CT and the photographic volume.
\begin{figure}
	\centering
	\caption[Natural User interaction]{Arm and hand gestures can also be used to perform interaction with the magic mirror AR view. (a) When the system is in the transverse slice mode, the user could move their hand up or down to choose the interesting slice image (b) The user can move the hand to relocate the \textit{see-through} window.}
	\label{fig:3-MMC:NUI}
	\subfloat[Gesture-based interaction for slices]{\label{fig:3-MMC:NUI:a}
		\includegraphics[height = 7cm]{figures/3-MMC/slicing}
	}
	\subfloat[Reloating \textit{see-through} window]{ \label{fig:3-MMC:NUI:b}
		\includegraphics[height = 7cm]{figures/3-MMC/ChooseWindow}
	}
\end{figure}
\paragraph{Relocating the see-through window}
The \textit{see-through} window plays an important role in creating the personal \textit{in-situ} visualization of the anatomy.
As shown in \figurename{\ref{fig:3-MMC:NUI:b}}, the window position is controlled by the hand position. The user specific offset vector is added to the left hand joint to decide the window position. This interactive function motivates the user to learn where the interesting organ is. For the public demo for children, we limited the window position in one dimension (see \figurename{\ref{fig:3-MMC:Mirracle}) and the user moves up or down to change the window position to show different organ in the corresponding height.
	
\subsection{Evaluation of the framework}
%todo develop a system for anatomy education
The current system allows visualization of static anatomy on the user and offers a simple user interface to select CT, MR or photographic slices. Demos of the prototype have been given on various public occasions. This exposure to the public resulted in a several contacts with medical doctors (MD) from physiotherapy, anatomy, radiology, sports medicine, children's medicine, and with medical teacher and science centers who are interested in using such a system in education of medical students and pupils. While discussions with these contacts were encouraging, most MDs asked for precision.

As an augmented reality anatomy learning application, system usability are very important prior to its translation in classroom. We undertook one user study involving first year medical students took place to verify the learning potential and acceptability of our technology as a compliment to atlas textbooks in classroom.

\paragraph{Learning Scenario} For the system a list of question are developed by the medical partners. Up to now a first set of questions for the prototype has been generated. Each question asks for the location of an anatomical structure. In each question either the sagittal, coronal or transverse slice passing through an anatomical structure must be found. In the first step the student has to position the focus window at the correct location by moving his hand there. After positioning the window, the distance to the actual position of the structure is computed. If the distance exceeds a threshold it is considered as wrong. In this case the student has to reposition the focus window. After a position that is close to the structure has been selected, the focus window is fixed and a mode is activated where a more fine grained selection is possible. Here the movement of the hand is scaled down and the user can select a slice in the area of the focus window. Again the user has to confirm her selection, and has to reselect a slice if the selected one was too far from the correct one. After a set of questions has been answered, a score is presented, which is based on the number of tries a student required to find the correct slice.

\paragraph{Participants:} 72 medical students from the Anatomische Anstalt Der Ludwig-Maximilians-Universit\"at M\"unchen, having an age range between 21yrs and 28yrs, were included in this study. The distribution of gender was 38 male and 34 female. Their medical experience was: 50 participants did not have any expertise, 8 had paramedic training, 5 with healthcare training, and 9 with some other degree (e.g. biology, chemistry, and therapy). 

\paragraph{Analysis:} Responses to questions were based on a four point Likert Scale: (1) \textit{strongly disagree}, (2) \textit{disagree}, (3) \textit{agree}, and (4) \textit{strongly agree}. For statistical analysis, the response categories were reduced to Yes/No: Yes (\textit{agree} + \textit{strongly agree}); No (\textit{strongly disagree} + \textit{disagree}).

The study procedure included every participant to use the personalized magic mirror system for 15 minutes and try all available system functions and games. Participants were then asked to assess the learning potential of our technology by responding to the following questions:
\begin{itemize}
	\item[Q1-] is the system helpful for anatomy learning?  
	\item[Q2-] do you like to use the magic mirror? 
	\item[Q3-] is the presentation and visualization of CT volume acceptable? 
	\item[Q4-] do you like the AR view of 3D human anatomy? 
	\item[Q5-] what other information would you want to see from the 3D rendering? (Open question)
\end{itemize}
Frequencies (F) and percentages (\%) of response on the first four questions are given in \tablename{\ref{tb:3-MMC:userStudy}}. The questionnaire, focused on motivation and perception of the participants, showed statistically significant differences of all the questions. Percentages confirmed how the fresh students accept our magic mirror for anatomy learning.
\begin{table}
	\caption[User study with fresh medical students]{Frequencies and percentages of response of the fresh medical student about the AR system}
	\centering
	\label{tb:3-MMC:userStudy}
	\scriptsize
	\begin{center}
		\begin{tabular}{ccccccccc}
			\multicolumn{1}{c}{\space} & \multicolumn{2}{c}{\textbf{Q1}} & \multicolumn{2}{c}{\textbf{Q2}} & \multicolumn{2}{c}{\textbf{Q3}} & \multicolumn{2}{c}{\textbf{Q4}} \\
			\hline
			\space & \textit{F} &\textit{\%}& \textit{F} &\textit{\%}& \textit{F} &\textit{\%}& \textit{F} &\textit{\%} \\
			Yes & 62 & 86.1 & 60 & 83.3 & 68 & 94.4 & 66 & 91.7 \\
			No & 10 & 13.9 & 12 & 16.7 & 4 & 5.6 & 6 & 8.3 \\
			\hline
		\end{tabular}
	\end{center}
\end{table}

The results of question 5 are depicted in \tablename{\ref{tb:3-MMC:question5}. They indicate that the participants would eventually like the current magic mirror system to evolve to one that includes the visualization of complex anatomy models such as the vascular system, relations between different organs, extremities, etc. 
\begin{table}
	\caption[User study with fresh medical students]{Frequencies and percentages of response of the fresh medical student about the AR system}
	\centering
	\label{tb:3-MMC:userStudy}
	\scriptsize
	\begin{center}
		\begin{tabular}{ccccccccc}
			\multicolumn{1}{c}{\space} & \multicolumn{2}{c}{\textbf{Q1}} & \multicolumn{2}{c}{\textbf{Q2}} & \multicolumn{2}{c}{\textbf{Q3}} & \multicolumn{2}{c}{\textbf{Q4}} \\
			\hline
			\space & \textit{F} &\textit{\%}& \textit{F} &\textit{\%}& \textit{F} &\textit{\%}& \textit{F} &\textit{\%} \\
			Yes & 62 & 86.1 & 60 & 83.3 & 68 & 94.4 & 66 & 91.7 \\
			No & 10 & 13.9 & 12 & 16.7 & 4 & 5.6 & 6 & 8.3 \\
			\hline
		\end{tabular}
	\end{center}
\end{table}

\subsection{Conclusion}
The system does not require expensive hardware and can be set up with different display devices. Therefore, we have created a demo setup consisting only of a Kinect and a laptop that we can use to easily set up a demo of the system. The system has been shown to the public at several occasions. It was shown during the open day of a hospital, in a school and during conferences. The feedback of the users, in particular from children has been very positive. While the AR in-situ visualization attracts the attention of people, it turned out that most users would spend much more time using the volume slicing feature to understand where different organs are. During the demos, the system has been used by many people and it has shown to be robust. The calibration sometimes fails, in particular when people are wearing thicker coats or jackets. But if the position and angle of the Kinect is set well, calibration problems are reduced largely.

One appealing feature of the system is that with the Kinect we are using inexpensive standard hardware. In the future such a system could be made available to students or patients who have to do rehabilitation exercises at home. In addition to the full system using a large screen and a screen stand we also want to evaluate the benefit of making the system accessible to students when they are at home and at any time. We want to do this for two different reasons. First, there is a trend toward competency-based education in medicine. Instead of defining a curriculum, learning outcomes are defined. Students have to fulfill these learning outcomes. The advantage of competency-based education is that all students will have the same competency in the end. A student who is less skilled has to take more time to learn than a student who already has good skills. One requirement for this is that the students have to be able to educate themselves until they reach the required competency. We plan to use the AR magic mirror system both to allow them to do training and to test whether a learning outcome has been met. The magic mirror has to be made easily available to them so that they can use it for training at any time. The second reason to develop a distributed system which can easily be used by students is to collect user statistics.

This section presents a personalized augmented reality magic mirror system for anatomy education purposes. The prototype system is certified useful for anatomy learning and the majority of the medical students accepted the learning potential of the technology. The academic methodologies must be changed according to the advance of new technologies, but there is still a long way for this. Considering the benefits of the personalized and interactive AR system for motivation and perception of anatomy learning, new technologies can additionally be helpful to facilitate autonomous learning and secondarily to reduce laboratory material and instructor costs. Together with the anatomy community, we hope to initiate such discussions in integrating exciting user-specific and gaming concepts within curricula via anatomy learning systems. It was originally suggested to us that our system would have much more of an impact for medical education learning if it were to be translated today in medical schools and anatomy classrooms. As such, with the help of our partner and anatomy professor, we deliver the improved AR magic mirror to two anatomy classes within the Anatomy Department of the Ludwig Maximilian University (LMU) Medical School, Munich, Germany. The anatomy professors made it clear that the AR magic mirror system is exciting, but has to go beyond state-of-the-art technology to be truly useful for education. Our participants stressed the importance of visualization of anatomy that can change dynamically resulting from the actions of the user moving the body, and also for visualization of muscles. Furthermore, more advanced user interactions like the use of gaming elements would be required to make the use of the system for learning tasks more interesting.